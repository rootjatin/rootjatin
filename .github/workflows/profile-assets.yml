name: Update Profile Assets (Streak + Snake + HEIC->PNG)

on:
  workflow_dispatch:
  schedule:
    - cron: "25 0 * * *"   # daily (UTC)

permissions:
  contents: write

concurrency:
  group: profile-assets
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Convert space.HEIC -> assets/space.png (only if HEIC exists)
      - name: Convert HEIC -> PNG (if present)
        run: |
          set -e
          mkdir -p assets
          if [ -f "space.HEIC" ]; then
            sudo apt-get update
            sudo apt-get install -y libheif-examples
            heif-convert "space.HEIC" "assets/space.png"
          else
            echo "space.HEIC not found. Skipping."
          fi

      # Generate snake (SVG-only = reliable)
      - name: Generate contribution snake
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: rootjatin
          outputs: |
            dist/github-snake.svg
            dist/github-snake-dark.svg?palette=github-dark

      # Download streak card (local)
      - name: Download streak SVG
        run: |
          mkdir -p assets
          curl -L "https://streak-stats.demolab.com?user=rootjatin&theme=tokyonight&hide_border=true&border_radius=18" \
            -o assets/streak.svg

      # Commit back as YOU
      - name: Commit & push if changed (as rootjatin)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update profile assets"
          file_pattern: "assets/*.svg assets/*.png dist/*.svg"
          commit_user_name: "rootjatin"
          commit_user_email: "jatin100198@gmail.com"
          commit_author: "rootjatin <jatin100198@gmail.com>"
